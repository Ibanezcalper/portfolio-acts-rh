---
import conceptosData from "../../public/conceptos.json";
---

<div
    class="relative py-24 px-6 bg-white overflow-hidden"
    id="match-expert"
    data-conceptos={JSON.stringify(conceptosData)}
>
    <!-- Decorative Mesh -->
    <div
        class="absolute inset-0 bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:32px_32px] [mask-image:radial-gradient(ellipse_50%_50%_at_50%_50%,#000_70%,transparent_100%)] opacity-30"
    >
    </div>

    <div class="max-w-6xl mx-auto relative z-10">
        <header class="text-center mb-16 md:mb-20">
            <span
                class="inline-block px-4 py-1.5 bg-indigo-50 text-indigo-600 rounded-full text-[10px] font-black uppercase tracking-[0.2em] mb-4"
            >
                Test de Correlaci贸n
            </span>
            <h2
                class="text-4xl md:text-6xl font-black text-slate-900 tracking-tighter mb-6 text-balance leading-none"
            >
                Relaci贸n <span class="italic text-indigo-600">Conceptual</span>
            </h2>
            <p
                class="text-slate-500 font-medium max-w-xl mx-auto leading-relaxed text-pretty text-sm md:text-base"
            >
                Conecta cada t茅rmino con su definici贸n. Puedes <strong
                    >arrastrar</strong
                > los elementos o <strong>hacer clic</strong> en un t茅rmino y luego
                en su definici贸n.
            </p>
        </header>

        <div
            class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-12 lg:gap-20 relative select-none touch-manipulation"
            id="match-arena-match"
        >
            <!-- Terms -->
            <div class="space-y-4 md:space-y-6" id="terms-col-match">
                <h3
                    class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6 md:mb-10 pl-4 border-l-4 border-indigo-500"
                >
                    T茅rmino Estrat茅gico
                </h3>
                <!-- JS Populated -->
            </div>

            <!-- Definitions -->
            <div class="space-y-4 md:space-y-6" id="defs-col-match">
                <h3
                    class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6 md:mb-10 pl-4 border-l-4 border-emerald-500"
                >
                    Definici贸n Operativa
                </h3>
                <!-- JS Populated -->
            </div>
        </div>

        <div class="mt-16 md:mt-20 flex flex-col items-center gap-6">
            <div class="flex items-center gap-4">
                <span
                    id="timer-badge-match"
                    class="px-4 py-2 bg-slate-900 text-white rounded-xl font-mono font-bold tracking-tighter text-lg"
                    >00:00</span
                >
                <span
                    id="match-score-match"
                    class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-xl font-black text-lg"
                    >0/5</span
                >
            </div>
        </div>
    </div>

    <div class="flex justify-center mt-12">
        <button
            id="reset-match"
            class="px-10 py-5 bg-slate-100 hover:bg-slate-200 text-slate-900 rounded-[2rem] font-black text-xs md:text-sm transition-all active:scale-95 group flex items-center gap-4 border border-slate-200"
        >
            <svg
                class="w-4 h-4 group-hover:rotate-180 transition-transform duration-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2.5"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                ></path>
            </svg>
            REINICIAR DESAFO
        </button>
    </div>
</div>

<!-- Victory Modal Overlay -->
<div
    id="victory-modal-match"
    class="fixed inset-0 z-[200] bg-slate-900/40 backdrop-blur-xl flex items-center justify-center opacity-0 pointer-events-none transition-all duration-500"
>
    <div
        class="bg-white p-12 rounded-[2.5rem] shadow-2xl text-center transform scale-90 transition-transform duration-500 max-w-sm mx-auto"
    >
        <div
            class="w-24 h-24 bg-indigo-100/50 rounded-full flex items-center justify-center mx-auto mb-8 text-4xl animate-bounce"
        >
            
        </div>
        <h4 class="text-3xl font-black text-slate-900 mb-4 tracking-tighter">
            隆EXCELENTE!
        </h4>
        <p class="text-slate-500 font-medium mb-8">
            Has correlacionado todos los t茅rminos en <span
                id="finish-time-match"
                class="text-indigo-600 font-bold">00:00</span
            >.
        </p>
        <button
            id="close-modal-match"
            class="w-full py-5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-black text-sm transition-all shadow-xl shadow-indigo-900/20"
            >CONTINUAR APRENDIENDO</button
        >
    </div>
</div>

<style is:global>
    .match-item {
        background: white;
        border: 2px solid #f1f5f9;
        padding: 1rem;
        border-radius: 1.25rem;
        cursor: grab;
        transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        font-weight: 700;
        color: #1e293b;
        position: relative;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 4rem;
        font-size: 0.8rem;
        text-align: center;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
        user-select: none;
        touch-action: manipulation;
    }
    @media (min-width: 768px) {
        .match-item {
            padding: 1.25rem 2rem;
            min-height: 5.5rem;
            font-size: 0.95rem;
            border-radius: 1.5rem;
        }
    }
    .match-item:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
    }
    .match-item:active {
        cursor: grabbing;
    }
    .match-item:hover:not(.matched):not(.dragging) {
        border-color: #6366f1;
        background: #f8fafc;
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
    }
    .match-item.selected {
        border-color: #6366f1;
        background: #eef2ff;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        transform: scale(1.02);
    }
    .match-item.matched {
        background: #f0fdf4 !important;
        border-color: #10b981 !important;
        color: #065f46 !important;
        cursor: default;
        opacity: 0.7;
        pointer-events: none;
        transform: none !important;
        box-shadow: none !important;
    }

    .drop-zone {
        border: 2px dashed #e2e8f0;
        background: #f8fafc;
        padding: 1rem;
        border-radius: 1.25rem;
        min-height: 5.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 0.75rem;
        font-weight: 500;
        color: #64748b;
        transition: all 0.3s;
        position: relative;
        cursor: pointer;
        touch-action: manipulation;
    }
    @media (min-width: 768px) {
        .drop-zone {
            padding: 1.25rem;
            min-height: 7rem;
            font-size: 0.875rem;
            border-radius: 1.5rem;
        }
    }
    .drop-zone:hover:not(.matched) {
        border-color: #10b981;
        background: #f0fdf4;
    }
    .drop-zone.drag-over {
        border-color: #6366f1;
        background: #eef2ff;
        color: #6366f1;
    }
    .drop-zone.matched {
        border-style: solid;
        border-color: #10b981;
        background: #f0fdf4;
        color: #065f46;
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
        cursor: default;
    }

    .dragging {
        opacity: 0.5;
        transform: scale(0.95);
        z-index: 100;
        pointer-events: none;
    }
    @keyframes shake {
        0%,
        100% {
            transform: translateX(0);
        }
        25% {
            transform: translateX(-5px);
        }
        75% {
            transform: translateX(5px);
        }
    }
    .error-shake {
        animation: shake 0.3s ease-in-out;
        border-color: #ef4444 !important;
    }
</style>

<script>
    (function () {
        const container = document.getElementById("match-expert");
        if (!container) return;
        const conceptosData = JSON.parse(
            container.getAttribute("data-conceptos") || "[]",
        );

        const TOTAL = 5;
        let score = 0;
        let startTime: number | null = null;
        let timerInterval: any = null;
        let selectedTermId: string | null = null;

        const tCol = document.getElementById("terms-col-match");
        const dCol = document.getElementById("defs-col-match");
        const resetB = document.getElementById("reset-match");
        const scB = document.getElementById("match-score-match");
        const timerE = document.getElementById("timer-badge-match");
        const modalE = document.getElementById("victory-modal-match");
        const finishTimeE = document.getElementById("finish-time-match");
        const closeModalB = document.getElementById("close-modal-match");

        function init() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
            startTime = null;
            selectedTermId = null;
            if (timerE) timerE.textContent = "00:00";
            score = 0;
            if (scB) scB.textContent = `0/${TOTAL}`;

            if (tCol)
                tCol.querySelectorAll(".match-item").forEach((e) => e.remove());
            if (dCol)
                dCol.querySelectorAll(".drop-zone").forEach((e) => e.remove());

            if (modalE) {
                modalE.classList.add("pointer-events-none");
                modalE.classList.remove("opacity-100");
                modalE.querySelector("div")?.classList.add("scale-90");
            }

            // True randomness
            const pool = [...conceptosData]
                .sort(() => 0.5 - Math.random())
                .slice(0, TOTAL);

            const terms = [...pool].sort(() => 0.5 - Math.random());
            const defs = [...pool].sort(() => 0.5 - Math.random());

            terms.forEach((t) => {
                const el = document.createElement("div");
                el.className = "match-item shadow-sm";
                el.textContent = t.termino;
                el.draggable = true;
                el.dataset.id = t.termino;

                el.addEventListener("dragstart", (e) => {
                    if (!startTime) startTimer();
                    el.classList.add("dragging");
                    e.dataTransfer?.setData("text/plain", t.termino);
                });
                el.addEventListener("dragend", () =>
                    el.classList.remove("dragging"),
                );

                el.addEventListener("click", () => {
                    if (!startTime) startTimer();
                    if (el.classList.contains("matched")) return;

                    document
                        .querySelectorAll(".match-item")
                        .forEach((m) => m.classList.remove("selected"));
                    if (selectedTermId === t.termino) {
                        selectedTermId = null;
                    } else {
                        selectedTermId = t.termino;
                        el.classList.add("selected");
                    }
                });

                // Touch
                el.addEventListener("touchstart", () => {
                    if (!startTime) startTimer();
                });
                el.addEventListener("touchmove", (e) => {
                    el.classList.add("dragging");
                    const touch = e.touches[0];
                    const target = document.elementFromPoint(
                        touch.clientX,
                        touch.clientY,
                    );
                    document
                        .querySelectorAll(".drop-zone")
                        .forEach((dz) => dz.classList.remove("drag-over"));
                    const dropZone = target?.closest(".drop-zone");
                    if (dropZone) dropZone.classList.add("drag-over");
                });
                el.addEventListener("touchend", (e) => {
                    el.classList.remove("dragging");
                    const touch = e.changedTouches[0];
                    const target = document.elementFromPoint(
                        touch.clientX,
                        touch.clientY,
                    );
                    const dropZone = target?.closest(
                        ".drop-zone",
                    ) as HTMLElement;
                    document
                        .querySelectorAll(".drop-zone")
                        .forEach((dz) => dz.classList.remove("drag-over"));
                    if (dropZone) handleDrop(t.termino, dropZone);
                });

                tCol?.appendChild(el);
            });

            defs.forEach((d) => {
                const el = document.createElement("div");
                el.className = "drop-zone";
                el.textContent = d.definicion;
                el.dataset.id = d.termino;

                el.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    el.classList.add("drag-over");
                });
                el.addEventListener("dragleave", () =>
                    el.classList.remove("drag-over"),
                );
                el.addEventListener("drop", (e: DragEvent) => {
                    e.preventDefault();
                    el.classList.remove("drag-over");
                    const termId = e.dataTransfer?.getData("text/plain");
                    if (termId) handleDrop(termId, el);
                });

                el.addEventListener("click", () => {
                    if (selectedTermId) {
                        handleDrop(selectedTermId, el);
                        selectedTermId = null;
                        document
                            .querySelectorAll(".match-item")
                            .forEach((m) => m.classList.remove("selected"));
                    }
                });

                dCol?.appendChild(el);
            });
        }

        function handleDrop(termId: string, dropZone: HTMLElement) {
            if (dropZone.classList.contains("matched")) return;

            if (termId === dropZone.dataset.id) {
                const originalDef = dropZone.textContent;
                dropZone.classList.add("matched");
                dropZone.innerHTML = `<div class="flex flex-col items-center">
                    <span class="text-indigo-600 font-black text-lg mb-2">${termId}</span>
                    <span class="text-[11px] leading-tight font-medium text-slate-500 max-w-[95%]">${originalDef}</span>
                </div>`;

                const termEl = tCol?.querySelector(
                    `[data-id="${termId}"]`,
                ) as HTMLElement;
                if (termEl) {
                    termEl.classList.add("matched");
                    termEl.classList.remove("selected");
                }

                score++;
                if (scB) scB.textContent = `${score}/${TOTAL}`;
                if (score === TOTAL) win();
            } else {
                dropZone.classList.add("error-shake");
                setTimeout(() => dropZone.classList.remove("error-shake"), 500);
            }
        }

        function startTimer() {
            if (timerInterval) return;
            startTime = Date.now();
            timerInterval = setInterval(() => {
                if (startTime === null) return;
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const m = String(Math.floor(elapsed / 60)).padStart(2, "0");
                const s = String(elapsed % 60).padStart(2, "0");
                if (timerE) timerE.textContent = `${m}:${s}`;
            }, 1000);
        }

        function win() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
            if (finishTimeE && timerE)
                finishTimeE.textContent = timerE.textContent;
            if (modalE) {
                modalE.classList.remove("pointer-events-none");
                modalE.classList.add("opacity-100");
                modalE.querySelector("div")?.classList.remove("scale-90");
            }
        }

        if (resetB) resetB.addEventListener("click", init);
        if (closeModalB) closeModalB.addEventListener("click", init);

        init();
    })();
</script>
