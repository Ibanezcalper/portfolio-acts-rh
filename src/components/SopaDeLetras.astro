---
import conceptosData from "../../public/conceptos.json";
---

<div class="relative py-24 px-6 bg-slate-50 overflow-hidden" id="sopa-expert">
    <!-- Decorative Elements -->
    <div class="absolute top-0 left-0 w-full h-full -z-10 opacity-40">
        <div
            class="absolute top-10 left-10 w-64 h-64 bg-blue-200 rounded-full blur-[100px]"
        >
        </div>
        <div
            class="absolute bottom-10 right-10 w-96 h-96 bg-indigo-100 rounded-full blur-[120px]"
        >
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col lg:flex-row gap-16 items-start">
            <!-- Info & Words -->
            <div class="lg:w-1/3 sticky top-32">
                <header class="mb-12">
                    <span
                        class="inline-block px-4 py-1.5 bg-blue-100 text-blue-700 rounded-xl text-[10px] font-black uppercase tracking-widest mb-4"
                    >
                        Desaf√≠o de Concentraci√≥n
                    </span>
                    <h2
                        class="text-5xl font-black text-slate-900 tracking-tighter mb-6 leading-none text-balance"
                    >
                        Sopa de <span class="text-blue-600">Letras</span>
                    </h2>
                    <p
                        class="text-slate-500 font-medium leading-relaxed text-pretty"
                    >
                        Encuentra los t√©rminos clave ocultos en la rejilla. Las
                        palabras pueden estar en horizontal o vertical,
                        incluyendo sus versiones invertidas.
                    </p>
                </header>

                <div
                    class="bg-white/50 p-8 rounded-[2rem] border border-white shadow-sm"
                >
                    <div class="flex items-center justify-between mb-8">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200"
                            >
                                <svg
                                    class="w-5 h-5"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2.5"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                                    ></path>
                                </svg>
                            </div>
                            <div>
                                <h3
                                    class="text-sm font-black text-slate-800 uppercase tracking-tight"
                                >
                                    Lista de Palabras
                                </h3>
                                <p
                                    class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
                                    id="score-badge-sopa"
                                >
                                    0 / 0 Encontradas
                                </p>
                            </div>
                        </div>
                        <span
                            id="timer-badge-sopa"
                            class="px-3 py-1 bg-blue-50 text-blue-600 rounded-lg font-mono font-bold tracking-tighter"
                            >00:00</span
                        >
                    </div>

                    <div class="grid grid-cols-2 gap-3" id="word-list-sopa">
                        <!-- JS Populated -->
                    </div>

                    <button
                        id="reset-sopa"
                        class="mt-10 w-full py-5 bg-slate-900 hover:bg-black text-white rounded-2xl font-black text-sm transition-all shadow-xl shadow-slate-900/20 active:scale-95 group flex items-center justify-center gap-3 focus-visible:ring-4 focus-visible:ring-blue-100 outline-none"
                    >
                        <svg
                            class="w-4 h-4 group-hover:rotate-180 transition-transform duration-500"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2.5"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                            ></path>
                        </svg>
                        REGENERAR TABLERO
                    </button>
                </div>
            </div>

            <!-- Grid -->
            <div class="lg:w-2/3 w-full">
                <div class="relative group select-none">
                    <!-- Victory Modal Overlay -->
                    <div
                        id="victory-modal-sopa"
                        class="absolute inset-0 z-50 bg-slate-900/40 backdrop-blur-xl flex items-center justify-center opacity-0 pointer-events-none transition-all duration-500 rounded-[3rem]"
                    >
                        <div
                            class="bg-white p-12 rounded-[2.5rem] shadow-2xl text-center transform scale-90 transition-transform duration-500 max-w-sm mx-auto"
                        >
                            <div
                                class="w-24 h-24 bg-blue-100/50 rounded-full flex items-center justify-center mx-auto mb-8 text-4xl animate-bounce"
                            >
                                üèÜ
                            </div>
                            <h4
                                class="text-3xl font-black text-slate-900 mb-4 tracking-tighter"
                            >
                                ¬°ESPECTACULAR!
                            </h4>
                            <p class="text-slate-500 font-medium mb-8">
                                Has encontrado todas las palabras en <span
                                    id="finish-time-sopa"
                                    class="text-blue-600 font-bold">00:00</span
                                >.
                            </p>
                            <button
                                id="close-modal-sopa"
                                class="w-full py-5 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black text-sm transition-all shadow-xl shadow-blue-900/20 focus-visible:ring-4 focus-visible:ring-blue-100 outline-none"
                                >CONTINUAR APRENDIENDO</button
                            >
                        </div>
                    </div>

                    <div class="overflow-x-auto pb-4 custom-scrollbar">
                        <div
                            id="grid-pnl-sopa"
                            class="relative bg-white p-2 md:p-8 rounded-[2rem] md:rounded-[3rem] border-4 md:border-8 border-white shadow-[0_20px_50px_rgba(0,0,0,0.03)] grid gap-1 md:gap-2.5 touch-manipulation mx-auto w-fit"
                        >
                            <!-- JS populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style is:global>
    .sopa-cell {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 0.875rem;
        color: #475569;
        background: #f8fafc;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border: 2px solid transparent;
    }
    @media (min-width: 768px) {
        .sopa-cell {
            width: 42px;
            height: 42px;
            font-size: 1.125rem;
            border-radius: 12px;
        }
    }
    .sopa-cell:hover:not(.found) {
        background: #eff6ff;
        color: #2563eb;
        transform: scale(1.1);
        z-index: 10;
    }
    .sopa-cell.selecting {
        background: #2563eb !important;
        color: white !important;
        transform: scale(0.95);
        border-radius: 50%;
    }
    .sopa-cell.found {
        background: #f0fdf4 !important;
        color: #10b981 !important;
        pointer-events: none;
    }
    .word-item {
        padding: 8px 12px;
        background: white;
        border: 1px solid #f1f5f9;
        border-radius: 12px;
        font-size: 9px;
        font-weight: 800;
        color: #64748b;
        text-align: center;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    @media (min-width: 768px) {
        .word-item {
            font-size: 11px;
        }
    }
    .word-item.found {
        background: #f0fdf4;
        color: #10b981;
        border-color: #bbf7d0;
        text-decoration: line-through;
        opacity: 0.6;
    }
</style>

<script>
    import conceptosData from "../../public/conceptos.json";

    function runSopaGame() {
        const SIZE = 14;
        const TARGET = 10;
        let grid: string[][] = [];
        let words: string[] = [];
        let found: string[] = [];
        let selecting = false;
        let selCells: { r: number; c: number }[] = [];
        let startC: { r: number; c: number } | null = null;

        const gridE = document.getElementById("grid-pnl-sopa");
        const wordListE = document.getElementById("word-list-sopa");
        const scoreE = document.getElementById("score-badge-sopa");
        const timerE = document.getElementById("timer-badge-sopa");
        const resetB = document.getElementById("reset-sopa");
        const modalE = document.getElementById("victory-modal-sopa");
        const finishTimeE = document.getElementById("finish-time-sopa");
        const closeModalB = document.getElementById("close-modal-sopa");

        let startTime: number | null = null;
        let timerInterval: any = null;

        function startTimer() {
            if (timerInterval) return;
            startTime = Date.now();
            timerInterval = setInterval(() => {
                if (startTime === null) return;
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const m = String(Math.floor(elapsed / 60)).padStart(2, "0");
                const s = String(elapsed % 60).padStart(2, "0");
                if (timerE) timerE.textContent = `${m}:${s}`;
            }, 1000);
        }

        function init() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
            startTime = null;
            if (timerE) timerE.textContent = "00:00";
            if (gridE) gridE.innerHTML = "";
            if (wordListE) wordListE.innerHTML = "";
            found = [];
            words = [];
            grid = Array(SIZE)
                .fill("")
                .map(() => Array(SIZE).fill(""));

            if (modalE) {
                modalE.classList.add("pointer-events-none");
                modalE.classList.remove("opacity-100");
                modalE.querySelector("div")?.classList.add("scale-90");
            }

            const pool = conceptosData
                .map((c) =>
                    c.termino.toUpperCase().replace(/[^A-Z√Å√â√ç√ì√ö√ë]/g, ""),
                )
                .filter((t) => t.length > 3 && t.length < SIZE - 2);

            const shuffledPool = [...new Set(pool)].sort(
                () => Math.random() - 0.5,
            );

            for (const word of shuffledPool) {
                if (words.length >= TARGET) break;
                let placed = false;
                let attempts = 0;
                while (!placed && attempts < 150) {
                    const dir = Math.floor(Math.random() * 4);
                    const r = Math.floor(Math.random() * SIZE);
                    const c = Math.floor(Math.random() * SIZE);
                    if (canPlace(word, r, c, dir)) {
                        place(word, r, c, dir);
                        placed = true;
                        words.push(word);
                    }
                    attempts++;
                }
            }

            const alpha = "ABCDEFGHIJKLMN√ëOPQRSTUVWXYZ√Å√â√ç√ì√ö";
            for (let r = 0; r < SIZE; r++) {
                for (let c = 0; c < SIZE; c++) {
                    if (grid[r][c] === "")
                        grid[r][c] =
                            alpha[Math.floor(Math.random() * alpha.length)];
                    const cell = document.createElement("div");
                    cell.className = "sopa-cell";
                    cell.textContent = grid[r][c];
                    cell.dataset.r = r.toString();
                    cell.dataset.c = c.toString();

                    cell.onmousedown = () => startSelect(cell, r, c);
                    cell.onmouseenter = () => moveSelect(cell, r, c);
                    cell.ontouchstart = (e) => {
                        e.preventDefault();
                        startSelect(cell, r, c);
                    };
                    cell.ontouchmove = (e) => {
                        e.preventDefault();
                        const touch = e.touches[0];
                        const el = document.elementFromPoint(
                            touch.clientX,
                            touch.clientY,
                        ) as HTMLElement;
                        if (el && el.classList.contains("sopa-cell")) {
                            moveSelect(
                                el,
                                parseInt(el.dataset.r!),
                                parseInt(el.dataset.c!),
                            );
                        }
                    };
                    cell.ontouchend = () => endSelect(cell, r, c);
                    gridE?.appendChild(cell);
                }
            }

            if (gridE) gridE.style.gridTemplateColumns = `repeat(${SIZE}, 1fr)`;

            words.forEach((w) => {
                const el = document.createElement("div");
                el.className = "word-item";
                el.textContent = w;
                el.dataset.word = w;
                wordListE?.appendChild(el);
            });

            updateUI();
        }

        function canPlace(w: string, r: number, c: number, d: number) {
            if (d === 0) {
                if (c + w.length > SIZE) return false;
                for (let i = 0; i < w.length; i++)
                    if (grid[r][c + i] !== "" && grid[r][c + i] !== w[i])
                        return false;
            } else if (d === 1) {
                if (r + w.length > SIZE) return false;
                for (let i = 0; i < w.length; i++)
                    if (grid[r + i][c] !== "" && grid[r + i][c] !== w[i])
                        return false;
            } else if (d === 2) {
                if (c - w.length < -1) return false;
                for (let i = 0; i < w.length; i++)
                    if (grid[r][c - i] !== "" && grid[r][c - i] !== w[i])
                        return false;
            } else if (d === 3) {
                if (r - w.length < -1) return false;
                for (let i = 0; i < w.length; i++)
                    if (grid[r - i][c] !== "" && grid[r - i][c] !== w[i])
                        return false;
            }
            return true;
        }

        function place(w: string, r: number, c: number, d: number) {
            for (let i = 0; i < w.length; i++) {
                if (d === 0) grid[r][c + i] = w[i];
                else if (d === 1) grid[r + i][c] = w[i];
                else if (d === 2) grid[r][c - i] = w[i];
                else if (d === 3) grid[r - i][c] = w[i];
            }
        }

        function startSelect(el: HTMLElement, r: number, c: number) {
            if (!startTime) startTimer();
            selecting = true;
            startC = { r, c };
            selCells = [{ r, c }];
            el.classList.add("selecting");
        }

        function moveSelect(el: HTMLElement, r: number, c: number) {
            if (!selecting || !startC) return;
            const dr = r - startC.r;
            const dc = c - startC.c;

            if (dr !== 0 && dc !== 0) return;

            gridE
                ?.querySelectorAll(".sopa-cell")
                .forEach((cell) => cell.classList.remove("selecting"));

            selCells = [];
            const steps = Math.max(Math.abs(dr), Math.abs(dc));
            const sr = dr === 0 ? 0 : dr / steps;
            const sc = dc === 0 ? 0 : dc / steps;

            for (let i = 0; i <= steps; i++) {
                const currR = startC.r + i * sr;
                const currC = startC.c + i * sc;
                selCells.push({ r: currR, c: currC });
                const cellEl = gridE?.querySelector(
                    `[data-r="${currR}"][data-c="${currC}"]`,
                );
                cellEl?.classList.add("selecting");
            }
        }

        function endSelect(el: HTMLElement | null, r: number, c: number) {
            if (!selecting || !startC) return;
            selecting = false;
            const word = selCells.map((cell) => grid[cell.r][cell.c]).join("");
            const rev = word.split("").reverse().join("");

            if (words.includes(word) && !found.includes(word)) {
                found.push(word);
                markFound(word);
            } else if (words.includes(rev) && !found.includes(rev)) {
                found.push(rev);
                markFound(rev);
            }

            gridE
                ?.querySelectorAll(".sopa-cell")
                .forEach((cell) => cell.classList.remove("selecting"));
            selCells = [];
            startC = null;
            updateUI();
            if (found.length === words.length && words.length > 0) win();
        }

        function markFound(word: string) {
            selCells.forEach((cell) => {
                const cellEl = gridE?.querySelector(
                    `[data-r="${cell.r}"][data-c="${cell.c}"]`,
                );
                cellEl?.classList.add("found");
            });
            const item = wordListE?.querySelector(`[data-word="${word}"]`);
            item?.classList.add("found");
        }

        function updateUI() {
            if (scoreE)
                scoreE.textContent = `${found.length} / ${words.length} Encontradas`;
        }

        function win() {
            if (timerInterval) clearInterval(timerInterval);
            if (finishTimeE && timerE)
                finishTimeE.textContent = timerE.textContent;
            if (modalE) {
                modalE.classList.remove("pointer-events-none");
                modalE.classList.add("opacity-100");
                modalE.querySelector("div")?.classList.remove("scale-90");
            }
        }

        window.addEventListener("mouseup", () => {
            if (selecting) {
                endSelect(null, 0, 0);
            }
        });

        if (resetB) resetB.onclick = init;
        if (closeModalB) closeModalB.onclick = init;

        init();
    }

    runSopaGame();
</script>
