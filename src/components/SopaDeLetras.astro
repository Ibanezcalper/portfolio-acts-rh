---
import conceptosData from "../../public/conceptos.json";
---

<div class="relative py-24 px-6 bg-slate-50" id="wordsearch-expert">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col lg:flex-row gap-16 items-start">
            <!-- Left Header & List -->
            <div class="lg:w-1/3 sticky top-32">
                <header class="mb-12">
                    <span
                        class="inline-block px-4 py-1.5 bg-blue-100 text-blue-700 rounded-xl text-[10px] font-black uppercase tracking-widest mb-4"
                    >
                        Desafío de Concentración
                    </span>
                    <h2
                        class="text-5xl font-black text-slate-900 tracking-tighter mb-6 leading-none"
                    >
                        Sopa de <span class="text-blue-600">Letras</span>
                    </h2>
                    <p class="text-slate-500 font-medium leading-relaxed">
                        Encuentra las 10 competencias estratégicas ocultas en la
                        matriz. Arrastra o toca sobre las letras para marcar.
                    </p>
                </header>

                <div
                    class="bg-white/40 backdrop-blur-md rounded-[2.5rem] p-8 border border-white shadow-2xl shadow-blue-900/5"
                >
                    <h3
                        class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-8 flex items-center justify-between"
                    >
                        Objetivos de Búsqueda
                        <span
                            id="score-badge"
                            class="px-3 py-1 bg-slate-900 text-white rounded-lg font-bold"
                            >0/10</span
                        >
                    </h3>
                    <ul id="word-list" class="grid grid-cols-2 gap-y-4 gap-x-6">
                        <!-- JS populated -->
                    </ul>

                    <button
                        id="reset-sopa"
                        class="mt-12 w-full py-5 bg-slate-900 hover:bg-black text-white rounded-2xl font-black text-sm transition-all shadow-xl shadow-slate-900/20 active:scale-95 group flex items-center justify-center gap-3"
                    >
                        <svg
                            class="w-5 h-5 group-hover:rotate-180 transition-transform duration-500"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2.5"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                            ></path>
                        </svg>
                        REGENERAR MATRIZ
                    </button>
                </div>
            </div>

            <!-- Right Grid Arena -->
            <div class="lg:w-2/3 w-full">
                <div class="relative group select-none">
                    <!-- Grid Glow -->
                    <div
                        class="absolute -inset-4 bg-gradient-to-br from-blue-500/10 to-indigo-500/5 rounded-[3rem] blur-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-700"
                    >
                    </div>

                    <div
                        id="grid-pnl"
                        class="relative bg-white p-4 md:p-8 rounded-[3rem] border-8 border-white shadow-[0_20px_50px_rgba(0,0,0,0.03)] grid gap-1.5 md:gap-2.5 overflow-hidden"
                    >
                        <!-- JS populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .grid-cell {
        aspect-ratio: 1/1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Outfit", sans-serif;
        font-weight: 800;
        font-size: 0.8rem;
        background: #f8fafc;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        color: #1e293b;
        text-transform: uppercase;
    }

    @media (min-width: 768px) {
        .grid-cell {
            font-size: 1.1rem;
            border-radius: 16px;
        }
    }

    .grid-cell:hover:not(.found) {
        background-color: #e2e8f0;
        transform: scale(1.1);
        z-index: 10;
        color: #2563eb;
    }

    .grid-cell.selected {
        background-color: #2563eb !important;
        color: white !important;
        transform: scale(0.9);
        box-shadow: 0 0 15px rgba(37, 99, 235, 0.4);
    }

    .grid-cell.found {
        background-color: #10b981 !important;
        color: white !important;
        border-radius: 12px;
        animation: spark 0.5s ease-out;
    }

    @keyframes spark {
        0% {
            transform: scale(1);
            opacity: 0.5;
        }
        50% {
            transform: scale(1.2);
            opacity: 1;
            filter: brightness(1.5);
        }
        100% {
            transform: scale(1);
        }
    }

    .word-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 700;
        font-size: 0.75rem;
        color: #64748b;
        transition: all 0.3s;
        padding: 0.5rem;
        border-radius: 0.75rem;
    }

    .word-item.word-found {
        color: #10b981;
        background: #f0fdf4;
        text-decoration: line-through;
        opacity: 0.6;
    }

    .word-item .dot {
        width: 6px;
        height: 6px;
        background: #cbd5e1;
        border-radius: 99px;
    }

    .word-item.word-found .dot {
        background: #10b981;
        box-shadow: 0 0 10px #10b981;
    }
</style>

<script define:vars={{ conceptosData }}>
    const SIZE = 14;
    const TARGET = 10;
    let grid = [];
    let words = [];
    let found = [];
    let selecting = false;
    let selCells = [];
    let startC = null;

    const gridE = document.getElementById("grid-pnl");
    const wordListE = document.getElementById("word-list");
    const scoreE = document.getElementById("score-badge");
    const resetB = document.getElementById("reset-sopa");

    function init() {
        gridE.innerHTML = "";
        wordListE.innerHTML = "";
        selCells = [];
        found = [];
        scoreE.textContent = `0/${TARGET}`;
        grid = Array(SIZE)
            .fill(null)
            .map(() => Array(SIZE).fill(""));

        // Prepare words
        const pool = conceptosData
            .map((c) => c.termino.toUpperCase().replace(/[^A-Z]/g, ""))
            .filter((t) => t.length > 3 && t.length < SIZE - 2)
            .sort(() => 0.5 - Math.random());

        words = [...new Set(pool)].slice(0, TARGET);

        // Word Placement
        words.forEach((word) => {
            let placed = false;
            let attempts = 0;
            while (!placed && attempts < 100) {
                const dir = Math.floor(Math.random() * 3); // 0:H, 1:V, 2:D
                const r = Math.floor(Math.random() * SIZE);
                const c = Math.floor(Math.random() * SIZE);

                if (canPlace(word, r, c, dir)) {
                    place(word, r, c, dir);
                    placed = true;
                }
                attempts++;
            }
        });

        // Fill Noise
        const alpha = "ABCDEFGHIJKLMNÑOPQRSTUVWXYZ";
        for (let r = 0; r < SIZE; r++) {
            for (let c = 0; c < SIZE; c++) {
                if (!grid[r][c])
                    grid[r][c] =
                        alpha[Math.floor(Math.random() * alpha.length)];
            }
        }

        render();
    }

    function canPlace(w, r, c, d) {
        if (d === 0) {
            // H
            if (c + w.length > SIZE) return false;
            for (let i = 0; i < w.length; i++)
                if (grid[r][c + i] && grid[r][c + i] !== w[i]) return false;
        } else if (d === 1) {
            // V
            if (r + w.length > SIZE) return false;
            for (let i = 0; i < w.length; i++)
                if (grid[r + i][c] && grid[r + i][c] !== w[i]) return false;
        } else {
            // D
            if (r + w.length > SIZE || c + w.length > SIZE) return false;
            for (let i = 0; i < w.length; i++)
                if (grid[r + i][c + i] && grid[r + i][c + i] !== w[i])
                    return false;
        }
        return true;
    }

    function place(w, r, c, d) {
        for (let i = 0; i < w.length; i++) {
            if (d === 0) grid[r][c + i] = w[i];
            else if (d === 1) grid[r + i][c] = w[i];
            else grid[r + i][c + i] = w[i];
        }
    }

    function render() {
        gridE.style.gridTemplateColumns = `repeat(${SIZE}, 1fr)`;
        for (let r = 0; r < SIZE; r++) {
            for (let c = 0; c < SIZE; c++) {
                const cell = document.createElement("div");
                cell.className = "grid-cell shadow-sm";
                cell.textContent = grid[r][c];
                cell.dataset.r = r;
                cell.dataset.c = c;

                cell.onmousedown = (e) => start(r, c, cell);
                cell.onmouseenter = (e) => move(r, c, cell);
                gridE.appendChild(cell);
            }
        }

        words.forEach((w) => {
            const li = document.createElement("li");
            li.id = `item-${w}`;
            li.className = "word-item uppercase tracking-tighter";
            li.innerHTML = `<span class="dot"></span> ${w}`;
            wordListE.appendChild(li);
        });
    }

    function start(r, c, el) {
        selecting = true;
        startC = { r, c };
        clearSel();
        addSel(r, c, el);
    }

    function move(r, c, el) {
        if (!selecting) return;
        const dr = r - startC.r;
        const dc = c - startC.c;
        if (dr === 0 || dc === 0 || Math.abs(dr) === Math.abs(dc)) {
            clearSel();
            const steps = Math.max(Math.abs(dr), Math.abs(dc));
            const sr = dr === 0 ? 0 : dr / Math.abs(dr);
            const sc = dc === 0 ? 0 : dc / Math.abs(dc);
            for (let i = 0; i <= steps; i++) {
                const tr = startC.r + i * sr;
                const tc = startC.c + i * sc;
                const targetEl = document.querySelector(
                    `[data-r="${tr}"][data-c="${tc}"]`,
                );
                if (targetEl) addSel(tr, tc, targetEl);
            }
        }
    }

    function addSel(r, c, el) {
        selCells.push(el);
        el.classList.add("selected");
    }

    function clearSel() {
        selCells.forEach((el) => el.classList.remove("selected"));
        selCells = [];
    }

    function end() {
        if (!selecting) return;
        selecting = false;
        const word = selCells.map((el) => el.textContent).join("");
        const rev = word.split("").reverse().join("");

        if (words.includes(word) && !found.includes(word)) win(word);
        else if (words.includes(rev) && !found.includes(rev)) win(rev);

        clearSel();
    }

    function win(w) {
        found.push(w);
        selCells.forEach((el) => el.classList.add("found"));
        document.getElementById(`item-${w}`).classList.add("word-found");
        scoreE.textContent = `${found.length}/${TARGET}`;

        if (found.length === TARGET) {
            setTimeout(
                () =>
                    alert(
                        "¡MISIÓN CUMPLIDA! Has encontrado todos los conceptos estratégicos.",
                    ),
                300,
            );
        }
    }

    window.onmouseup = end;
    resetB.onclick = init;
    init();
</script>
